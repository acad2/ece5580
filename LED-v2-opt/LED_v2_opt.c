/* Thanks for Valentina Banciu for pointing out 
   some bugs in previous versions
	Last updated: 17 Jan 2014
*/
#include <inttypes.h>

#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include <time.h>
#include "LED.h"


#if LED<=64
#define RN 	32
#elif LED<=128
#define RN 	48
#endif
#ifndef TS
#define TS	8
#define NIB	2
#endif
#define INDEX_FILTER ((1<<(NIB<<2))-1)

#if LED<64
#define ROLTKEY(k) ((k>>(LED))||((k)<<(64-(LED))))
#elif LED==64
#define ROLTKEY(k) (k)
#endif


uint64_t RoundKeys[RN] = { 0 };
const byte MixColMatrix[4][4] = {
	{4,  1, 2, 2},
	{8,  6, 5, 6},
	{11,14,10, 9},
	{2,  2,15,11},
};
const byte sbox[16] = {12, 5, 6, 11, 9, 0, 10, 13, 3, 14, 15, 8, 4, 7, 1, 2};
const byte RC[48] = {
	0x01, 0x03, 0x07, 0x0F, 0x1F, 0x3E, 0x3D, 0x3B, 0x37, 0x2F,
	0x1E, 0x3C, 0x39, 0x33, 0x27, 0x0E, 0x1D, 0x3A, 0x35, 0x2B,
	0x16, 0x2C, 0x18, 0x30, 0x21, 0x02, 0x05, 0x0B, 0x17, 0x2E,
	0x1C, 0x38, 0x31, 0x23, 0x06, 0x0D, 0x1B, 0x36, 0x2D, 0x1A,
	0x34, 0x29, 0x12, 0x24, 0x08, 0x11, 0x22, 0x04
};
const byte WORDFILTER = 0xF;

int DEBUG = 0;
inline byte FieldMult(byte a, byte b)
{
	const byte ReductionPoly = 0x3;
	byte x = a, ret = 0;
	int i;
	for(i = 0; i < 4; i++) {
		if((b>>i)&1) ret ^= x;
		if(x&0x8) {
			x <<= 1;
			x ^= ReductionPoly;
		}
		else x <<= 1;
	}
	return ret&WORDFILTER;
}

void SubCell(byte state[4][4])
{
	int i,j;
	for(i = 0; i < 4; i++)
		for(j = 0; j <  4; j++)
			state[i][j] = sbox[state[i][j]];
}

void ShiftRow(byte state[4][4])
{
	int i, j;
	byte tmp[4];
	for(i = 1; i < 4; i++) {
		for(j = 0; j < 4; j++)
			tmp[j] = state[i][j];
		for(j = 0; j < 4; j++)
			state[i][j] = tmp[(j+i)%4];
	}
}

void MixColumn(byte state[4][4])
{
	int i, j, k;
	byte tmp[4];
	for(j = 0; j < 4; j++){
		for(i = 0; i < 4; i++) {
			byte sum = 0;
			for(k = 0; k < 4; k++)
				sum ^= FieldMult(MixColMatrix[i][k], state[k][j]);
			tmp[i] = sum;
		}
		for(i = 0; i < 4; i++)
			state[i][j] = tmp[i];
	}
}

//uint64_t Ssbox[TS][1<<(NIB<<2)] = {{ 0 }};
uint64_t Ssbox[TS][1<<(NIB<<2)] =
{{11141205,11403351,10813531,10944602,10747986,10485840,11468894,10616913,11206748,11075677,10551385,11272278,10879059,11337823,11010132,10682456,15335541,15597687,15007867,15138938,14942322,14680176,15663230,14811249,15401084,15270013,14745721,15466614,15073395,15532159,15204468,14876792,5898421,6160567,5570747,5701818,5505202,5243056,6226110,5374129,5963964,5832893,5308601,6029494,5636275,6095039,5767348,5439672,7995557,8257703,7667883,7798954,7602338,7340192,8323246,7471265,8061100,7930029,7405737,8126630,7733411,8192175,7864484,7536808,4849701,5111847,4522027,4653098,4456482,4194336,5177390,4325409,4915244,4784173,4259881,4980774,4587555,5046319,4718628,4390952,655365,917511,327691,458762,262146,0,983054,131073,720908,589837,65545,786438,393219,851983,524292,196616,16384229,16646375,16056555,16187626,15991010,15728864,16711918,15859937,16449772,16318701,15794409,16515302,16122083,16580847,16253156,15925480,2752533,3014679,2424859,2555930,2359314,2097168,3080222,2228241,2818076,2687005,2162713,2883606,2490387,2949151,2621460,2293784,12189893,12452039,11862219,11993290,11796674,11534528,12517582,11665601,12255436,12124365,11600073,12320966,11927747,12386511,12058820,11731144,10092757,10354903,9765083,9896154,9699538,9437392,10420446,9568465,10158300,10027229,9502937,10223830,9830611,10289375,9961684,9634008,1704085,1966231,1376411,1507482,1310866,1048720,2031774,1179793,1769628,1638557,1114265,1835158,1441939,1900703,1573012,1245336,13238373,13500519,12910699,13041770,12845154,12583008,13566062,12714081,13303916,13172845,12648553,13369446,12976227,13434991,13107300,12779624,6946869,7209015,6619195,6750266,6553650,6291504,7274558,6422577,7012412,6881341,6357049,7077942,6684723,7143487,6815796,6488120,14287093,14549239,13959419,14090490,13893874,13631728,14614782,13762801,14352636,14221565,13697273,14418166,14024947,14483711,14156020,13828344,9044037,9306183,8716363,8847434,8650818,8388672,9371726,8519745,9109580,8978509,8454217,9175110,8781891,9240655,8912964,8585288,3801221,4063367,3473547,3604618,3408002,3145856,4128910,3276929,3866764,3735693,3211401,3932294,3539075,3997839,3670148,3342472},

{-1442818816,-1375709440,-1526703360,-1493149184,-1543482880,-1610592256,-1358930432,-1577037568,-1426039808,-1459593984,-1593812736,-1409264128,-1509928192,-1392484608,-1476373504,-1560258560,-369068800,-301959424,-452953344,-419399168,-469732864,-536842240,-285180416,-503287552,-352289792,-385843968,-520062720,-335514112,-436178176,-318734592,-402623488,-486508544,1509995776,1577105152,1426111232,1459665408,1409331712,1342222336,1593884160,1375777024,1526774784,1493220608,1359001856,1543550464,1442886400,1560329984,1476441088,1392556032,2046862592,2113971968,1962978048,1996532224,1946198528,1879089152,2130750976,1912643840,2063641600,2030087424,1895868672,2080417280,1979753216,2097196800,2013307904,1929422848,1241523456,1308632832,1157638912,1191193088,1140859392,1073750016,1325411840,1107304704,1258302464,1224748288,1090529536,1275078144,1174414080,1291857664,1207968768,1124083712,167773440,234882816,83888896,117443072,67109376,0,251661824,33554688,184552448,150998272,16779520,201328128,100664064,218107648,134218752,50333696,-100604672,-33495296,-184489216,-150935040,-201268736,-268378112,-16716288,-234823424,-83825664,-117379840,-251598592,-67049984,-167714048,-50270464,-134159360,-218044416,704648448,771757824,620763904,654318080,603984384,536875008,788536832,570429696,721427456,687873280,553654528,738203136,637539072,754982656,671093760,587208704,-1174354688,-1107245312,-1258239232,-1224685056,-1275018752,-1342128128,-1090466304,-1308573440,-1157575680,-1191129856,-1325348608,-1140800000,-1241464064,-1124020480,-1207909376,-1291794432,-1711221504,-1644112128,-1795106048,-1761551872,-1811885568,-1878994944,-1627333120,-1845440256,-1694442496,-1727996672,-1862215424,-1677666816,-1778330880,-1660887296,-1744776192,-1828661248,436245760,503355136,352361216,385915392,335581696,268472320,520134144,302027008,453024768,419470592,285251840,469800448,369136384,486579968,402691072,318806016,-905943808,-838834432,-989828352,-956274176,-1006607872,-1073717248,-822055424,-1040162560,-889164800,-922718976,-1056937728,-872389120,-973053184,-855609600,-939498496,-1023383552,1778398464,1845507840,1694513920,1728068096,1677734400,1610625024,1862286848,1644179712,1795177472,1761623296,1627404544,1811953152,1711289088,1828732672,1744843776,1660958720,-637471488,-570362112,-721356032,-687801856,-738135552,-805244928,-553583104,-771690240,-620692480,-654246656,-788465408,-603916800,-704580864,-587137280,-671026176,-754911232,-1979693824,-1912584448,-2063578368,-2030024192,-2080357888,-2147467264,-1895805440,-2113912576,-1962914816,-1996468992,-2130687744,-1946139136,-2046803200,-1929359616,-2013248512,-2097133568,973112576,1040221952,889228032,922782208,872448512,805339136,1057000960,838893824,989891584,956337408,822118656,1006667264,906003200,1023446784,939557888,855672832},

{-535904244,-804368372,1879990284,-267472884,806260748,917516,-1878089716,-2146512884,-1609682932,537845772,1074720780,1343127564,-1341243380,269381644,1611534348,-1072816116,-535969787,-804433915,1879924741,-267538427,806195205,851973,-1878155259,-2146578427,-1609748475,537780229,1074655237,1343062021,-1341308923,269316101,1611468805,-1072881659,-536363002,-804827130,1879531526,-267931642,805801990,458758,-1878548474,-2146971642,-1610141690,537387014,1074262022,1342668806,-1341702138,268922886,1611075590,-1073274874,-535838709,-804302837,1880055819,-267407349,806326283,983051,-1878024181,-2146447349,-1609617397,537911307,1074786315,1343193099,-1341177845,269447179,1611599883,-1072750581,-536625143,-805089271,1879269385,-268193783,805539849,196617,-1878810615,-2147233783,-1610403831,537124873,1073999881,1342406665,-1341964279,268660745,1610813449,-1073537015,-536821760,-805285888,1879072768,-268390400,805343232,0,-1879007232,-2147430400,-1610600448,536928256,1073803264,1342210048,-1342160896,268464128,1610616832,-1073733632,-536231926,-804696054,1879662602,-267800566,805933066,589834,-1878417398,-2146840566,-1610010614,537518090,1074393098,1342799882,-1341571062,269053962,1611206666,-1073143798,-536297459,-804761587,1879597069,-267866099,805867533,524301,-1878482931,-2146906099,-1610076147,537452557,1074327565,1342734349,-1341636595,268988429,1611141133,-1073209331,-536166397,-804630525,1879728131,-267735037,805998595,655363,-1878351869,-2146775037,-1609945085,537583619,1074458627,1342865411,-1341505533,269119491,1611272195,-1073078269,-536690674,-805154802,1879203854,-268259314,805474318,131086,-1878876146,-2147299314,-1610469362,537059342,1073934350,1342341134,-1342029810,268595214,1610747918,-1073602546,-536559601,-805023729,1879334927,-268128241,805605391,262159,-1878745073,-2147168241,-1610338289,537190415,1074065423,1342472207,-1341898737,268726287,1610878991,-1073471473,-536494072,-804958200,1879400456,-268062712,805670920,327688,-1878679544,-2147102712,-1610272760,537255944,1074130952,1342537736,-1341833208,268791816,1610944520,-1073405944,-536100860,-804564988,1879793668,-267669500,806064132,720900,-1878286332,-2146709500,-1609879548,537649156,1074524164,1342930948,-1341439996,269185028,1611337732,-1073012732,-536756217,-805220345,1879138311,-268324857,805408775,65543,-1878941689,-2147364857,-1610534905,536993799,1073868807,1342275591,-1342095353,268529671,1610682375,-1073668089,-536428543,-804892671,1879465985,-267997183,805736449,393217,-1878614015,-2147037183,-1610207231,537321473,1074196481,1342603265,-1341767679,268857345,1611010049,-1073340415,-536035326,-804499454,1879859202,-267603966,806129666,786434,-1878220798,-2146643966,-1609814014,537714690,1074589698,1342996482,-1341374462,269250562,1611403266,-1072947198},

{249564352,248515664,242224224,250612912,238029968,234884096,244321440,243272912,245369904,236981472,239078640,240127104,246418496,235932784,241175568,247467040,232785344,231736656,225445216,233833904,221250960,218105088,227542432,226493904,228590896,220202464,222299632,223348096,229639488,219153776,224396560,230688032,132122304,131073616,124782176,133170864,120587920,117442048,126879392,125830864,127927856,119539424,121636592,122685056,128976448,118490736,123733520,130024992,266341312,265292624,259001184,267389872,254806928,251661056,261098400,260049872,262146864,253758432,255855600,256904064,263195456,252709744,257952528,264244000,65014208,63965520,57674080,66062768,53479824,50333952,59771296,58722768,60819760,52431328,54528496,55576960,61868352,51382640,56625424,62916896,14680256,13631568,7340128,15728816,3145872,0,9437344,8388816,10485808,2097376,4194544,5243008,11534400,1048688,6291472,12582944,165677760,164629072,158337632,166726320,154143376,150997504,160434848,159386320,161483312,153094880,155192048,156240512,162531904,152046192,157288976,163580448,148901312,147852624,141561184,149949872,137366928,134221056,143658400,142609872,144706864,136318432,138415600,139464064,145755456,135269744,140512528,146804000,182453184,181404496,175113056,183501744,170918800,167772928,177210272,176161744,178258736,169870304,171967472,173015936,179307328,168821616,174064400,180355872,48238272,47189584,40898144,49286832,36703888,33558016,42995360,41946832,44043824,35655392,37752560,38801024,45092416,34606704,39849488,46140960,81792960,80744272,74452832,82841520,70258576,67112704,76550048,75501520,77598512,69210080,71307248,72355712,78647104,68161392,73404176,79695648,98568384,97519696,91228256,99616944,87034000,83888128,93325472,92276944,94373936,85985504,88082672,89131136,95422528,84936816,90179600,96471072,199230656,198181968,191890528,200279216,187696272,184550400,193987744,192939216,195036208,186647776,188744944,189793408,196084800,185599088,190841872,197133344,31459264,30410576,24119136,32507824,19924880,16779008,26216352,25167824,27264816,18876384,20973552,22022016,28313408,17827696,23070480,29361952,115343808,114295120,108003680,116392368,103809424,100663552,110100896,109052368,111149360,102760928,104858096,105906560,112197952,101712240,106955024,113246496,216007360,214958672,208667232,217055920,204472976,201327104,210764448,209715920,211812912,203424480,205521648,206570112,212861504,202375792,207618576,213910048},

{-1728005376,-1845446144,-1660896256,-1862224640,-1694453504,-1879003136,-1811892480,-1677674240,-1627343360,-1828667648,-1778336512,-1644121344,-1761560576,-1744781824,-1795116544,-1711229952,687909632,570468864,755018752,553690368,721461504,536911872,604022528,738240768,788571648,587247360,637578496,771793664,654354432,671133184,620798464,704685056,-654259456,-771700224,-587150336,-788478720,-620707584,-805257216,-738146560,-603928320,-553597440,-754921728,-704590592,-570375424,-687814656,-671035904,-721370624,-637484032,419453696,302012928,486562816,285234432,453005568,268455936,335566592,469784832,520115712,318791424,369122560,503337728,385898496,402677248,352342528,436229120,-1191175424,-1308616192,-1124066304,-1325394688,-1157623552,-1342173184,-1275062528,-1140844288,-1090513408,-1291837696,-1241506560,-1107291392,-1224730624,-1207951872,-1258286592,-1174400000,150997760,33556992,218106880,16778496,184549632,0,67110656,201328896,251659776,50335488,100666624,234881792,117442560,134221312,83886592,167773184,1224768256,1107327488,1291877376,1090548992,1258320128,1073770496,1140881152,1275099392,1325430272,1124105984,1174437120,1308652288,1191213056,1207991808,1157657088,1241543680,-922707200,-1040147968,-855598080,-1056926464,-889155328,-1073704960,-1006594304,-872376064,-822045184,-1023369472,-973038336,-838823168,-956262400,-939483648,-989818368,-905931776,-117413120,-234853888,-50304000,-251632384,-83861248,-268410880,-201300224,-67081984,-16751104,-218075392,-167744256,-33529088,-150968320,-134189568,-184524288,-100637696,956365568,838924800,1023474688,822146304,989917440,805367808,872478464,1006696704,1057027584,855703296,906034432,1040249600,922810368,939589120,889254400,973140992,1761663744,1644222976,1828772864,1627444480,1795215616,1610665984,1677776640,1811994880,1862325760,1661001472,1711332608,1845547776,1728108544,1744887296,1694552576,1778439168,-385860864,-503301632,-318751744,-520080128,-352308992,-536858624,-469747968,-335529728,-285198848,-486523136,-436192000,-301976832,-419416064,-402637312,-452972032,-369085440,2030078720,1912637952,2097187840,1895859456,2063630592,1879080960,1946191616,2080409856,2130740736,1929416448,1979747584,2113962752,1996523520,2013302272,1962967552,2046854144,-1996428544,-2113869312,-1929319424,-2130647808,-1962876672,-2147426304,-2080315648,-1946097408,-1895766528,-2097090816,-2046759680,-1912544512,-2029983744,-2013204992,-2063539712,-1979653120,1493183232,1375742464,1560292352,1358963968,1526735104,1342185472,1409296128,1543514368,1593845248,1392520960,1442852096,1577067264,1459628032,1476406784,1426072064,1509958656,-1459598592,-1577039360,-1392489472,-1593817856,-1426046720,-1610596352,-1543485696,-1409267456,-1358936576,-1560260864,-1509929728,-1375714560,-1493153792,-1476375040,-1526709760,-1442823168},

{10027195,9568442,10289340,9502901,10158257,9437360,9699511,10223801,10420406,9633983,9830589,10354867,9896120,9961662,9765042,10092724,2687147,2228394,2949292,2162853,2818209,2097312,2359463,2883753,3080358,2293935,2490541,3014819,2556072,2621614,2424994,2752676,14221515,13762762,14483660,13697221,14352577,13631680,13893831,14418121,14614726,13828303,14024909,14549187,14090440,14155982,13959362,14287044,1638491,1179738,1900636,1114197,1769553,1048656,1310807,1835097,2031702,1245279,1441885,1966163,1507416,1572958,1376338,1704020,12124187,11665434,12386332,11599893,12255249,11534352,11796503,12320793,12517398,11730975,11927581,12451859,11993112,12058654,11862034,12189716,589835,131082,851980,65541,720897,0,262151,786441,983046,196623,393229,917507,458760,524302,327682,655364,4784251,4325498,5046396,4259957,4915313,4194416,4456567,4980857,5177462,4391039,4587645,5111923,4653176,4718718,4522098,4849780,13172891,12714138,13435036,12648597,13303953,12583056,12845207,13369497,13566102,12779679,12976285,13500563,13041816,13107358,12910738,13238420,16318571,15859818,16580716,15794277,16449633,15728736,15990887,16515177,16711782,15925359,16121965,16646243,16187496,16253038,16056418,16384100,3735803,3277050,3997948,3211509,3866865,3145968,3408119,3932409,4129014,3342591,3539197,4063475,3604728,3670270,3473650,3801332,6881499,6422746,7143644,6357205,7012561,6291664,6553815,7078105,7274710,6488287,6684893,7209171,6750424,6815966,6619346,6947028,15269947,14811194,15532092,14745653,15401009,14680112,14942263,15466553,15663158,14876735,15073341,15597619,15138872,15204414,15007794,15335476,7929995,7471242,8192140,7405701,8061057,7340160,7602311,8126601,8323206,7536783,7733389,8257667,7798920,7864462,7667842,7995524,8978667,8519914,9240812,8454373,9109729,8388832,8650983,9175273,9371878,8585455,8782061,9306339,8847592,8913134,8716514,9044196,5832747,5373994,6094892,5308453,5963809,5242912,5505063,6029353,6225958,5439535,5636141,6160419,5701672,5767214,5570594,5898276,11075659,10616906,11337804,10551365,11206721,10485824,10747975,11272265,11468870,10682447,10879053,11403331,10944584,11010126,10813506,11141188},

{249564080,248515488,242224064,250612560,238029584,234883840,244321136,243272592,245369696,236981232,239078352,240126768,246418304,235932640,241175328,247466816,232786608,231738016,225446592,233835088,221252112,218106368,227543664,226495120,228592224,220203760,222300880,223349296,229640832,219155168,224397856,230689344,132123824,131075232,124783808,133172304,120589328,117443584,126880880,125832336,127929440,119540976,121638096,122686512,128978048,118492384,123735072,130026560,266339760,265291168,258999744,267388240,254805264,251659520,261096816,260048272,262145376,253756912,255854032,256902448,263193984,252708320,257951008,264242496,65012144,63963552,57672128,66060624,53477648,50331904,59769200,58720656,60817760,52429296,54526416,55574832,61866368,51380704,56623392,62914880,14680240,13631648,7340224,15728720,3145744,0,9437296,8388752,10485856,2097392,4194512,5242928,11534464,1048800,6291488,12582976,165676976,164628384,158336960,166725456,154142480,150996736,160434032,159385488,161482592,153094128,155191248,156239664,162531200,152045536,157288224,163579712,148900272,147851680,141560256,149948752,137365776,134220032,143657328,142608784,144705888,136317424,138414544,139462960,145754496,135268832,140511520,146803008,182453936,181405344,175113920,183502416,170919440,167773696,177210992,176162448,178259552,169871088,171968208,173016624,179308160,168822496,174065184,180356672,48238512,47189920,40898496,49286992,36704016,33558272,42995568,41947024,44044128,35655664,37752784,38801200,45092736,34607072,39849760,46141248,81792432,80743840,74452416,82840912,70257936,67112192,76549488,75500944,77598048,69209584,71306704,72355120,78646656,68160992,73403680,79695168,98567088,97518496,91227072,99615568,87032592,83886848,93324144,92275600,94372704,85984240,88081360,89129776,95421312,84935648,90178336,96469824,199231664,198183072,191891648,200280144,187697168,184551424,193988720,192940176,195037280,186648816,188745936,189794352,196085888,185600224,190842912,197134400,31461040,30412448,24121024,32509520,19926544,16780800,26218096,25169552,27266656,18878192,20975312,22023728,28315264,17829600,23072288,29363776,115344048,114295456,108004032,116392528,103809552,100663808,110101104,109052560,111149664,102761200,104858320,105906736,112198272,101712608,106955296,113246784,216007856,214959264,208667840,217056336,204473360,201327616,210764912,209716368,211813472,203425008,205522128,206570544,212862080,202376416,207619104,213910592},

{-535908341,-804347893,1880014859,-267497461,806227979,917515,-1878102005,-2146529269,-1609670645,537849867,1074712587,1343107083,-1341226997,269410315,1611538443,-1072807925,-535973878,-804413430,1879949322,-267562998,806162442,851978,-1878167542,-2146594806,-1609736182,537784330,1074647050,1343041546,-1341292534,269344778,1611472906,-1072873462,-536367092,-804806644,1879556108,-267956212,805769228,458764,-1878560756,-2146988020,-1610129396,537391116,1074253836,1342648332,-1341685748,268951564,1611079692,-1073266676,-535842811,-804282363,1880080389,-267431931,806293509,983045,-1878036475,-2146463739,-1609605115,537915397,1074778117,1343172613,-1341161467,269475845,1611603973,-1072742395,-536629247,-805068799,1879293953,-268218367,805507073,196609,-1878822911,-2147250175,-1610391551,537128961,1073991681,1342386177,-1341947903,268689409,1610817537,-1073528831,-536825856,-805265408,1879097344,-268414976,805310464,0,-1879019520,-2147446784,-1610588160,536932352,1073795072,1342189568,-1342144512,268492800,1610620928,-1073725440,-536236025,-804675577,1879687175,-267825145,805900295,589831,-1878429689,-2146856953,-1609998329,537522183,1074384903,1342779399,-1341554681,269082631,1611210759,-1073135609,-536301559,-804741111,1879621641,-267890679,805834761,524297,-1878495223,-2146922487,-1610063863,537456649,1074319369,1342713865,-1341620215,269017097,1611145225,-1073201143,-536170490,-804610042,1879752710,-267759610,805965830,655366,-1878364154,-2146791418,-1609932794,537587718,1074450438,1342844934,-1341489146,269148166,1611276294,-1073070074,-536694769,-805134321,1879228431,-268283889,805441551,131087,-1878888433,-2147315697,-1610457073,537063439,1073926159,1342320655,-1342013425,268623887,1610752015,-1073594353,-536563699,-805003251,1879359501,-268152819,805572621,262157,-1878757363,-2147184627,-1610326003,537194509,1074057229,1342451725,-1341882355,268754957,1610883085,-1073463283,-536498173,-804937725,1879425027,-268087293,805638147,327683,-1878691837,-2147119101,-1610260477,537260035,1074122755,1342517251,-1341816829,268820483,1610948611,-1073397757,-536104952,-804544504,1879818248,-267694072,806031368,720904,-1878298616,-2146725880,-1609867256,537653256,1074515976,1342910472,-1341423608,269213704,1611341832,-1073004536,-536760306,-805199858,1879162894,-268349426,805376014,65550,-1878953970,-2147381234,-1610522610,536997902,1073860622,1342255118,-1342078962,268558350,1610686478,-1073659890,-536432638,-804872190,1879490562,-268021758,805703682,393218,-1878626302,-2147053566,-1610194942,537325570,1074188290,1342582786,-1341751294,268886018,1611014146,-1073332222,-536039420,-804478972,1879883780,-267628540,806096900,786436,-1878233084,-2146660348,-1609801724,537718788,1074581508,1342976004,-1341358076,269279236,1611407364,-1072939004}};

 
//uint64_t RRC[RN] = { 0 };
uint64_t RRC[RN] = {5348033148813316,14355232405651460,32369630919327748,32369699638804500,32369837077758004,27866512327245940,23362912698826868,14355713441988724,32370043236188260,32369974516711508,27866237449338932,18859313070407796,5348514185150580,14355644722511972,32369905797234756,27866100010385428,23362637820919860,9852113813569652,23362843979350116,14355576003035220,27866168729862180,18859175631454292,844639678824500,844845837254756,5348308026720324,9851632777232388,23362431662489604,14355301125128212,32369768358281252,27866374888292436,18859038192500788,844914556731508};
void BuildTableSCShRMCS()
{
	int r;
	uint64_t x;
	for(r = 0; r < TS; r++){ //  build the table for Ssbox[r][.]
		for(x = 0; x != (1<<(NIB<<2)); x++) // for all values of the row
		{
			uint8_t c[NIB];
			uint64_t result = 0;
			int i, j;
			for(i = 0; i < NIB; i++){ // for all cells of this row value, we are dealing with the cell[r][i] after shiftrow
				if(r* NIB + i >= 16) break;
				c[i] = sbox[(x>>(i*4))&0xF];
				int row = (r*NIB + i) >> 2;
				int col = (((r*NIB + i) & 3) + 4 - row)&3; // column after shift row
				for(j = 0; j < 4; j++) {
					uint8_t v = FieldMult(c[i], MixColMatrix[j][row]);
					result ^= ((((uint64_t) v)&0xFULL) << (j*16+col*4));
				}
			}
			Ssbox[r][x] = result;
	//		printf("%i ", result);
		}
	//	printf("\n\n");
	}

	// precompute the constants
	for(r = 0; r < RN; r++)
	{
		uint64_t t = 0;
		t |= (uint64_t) (LED>>4)&0xF;
		t |= ((uint64_t) 1^((LED>>4) & 0xFF)) << 16;
		t |= ((uint64_t) 2^(LED&0xF)) << 32;
		t |= ((uint64_t) 3^(LED&0xF)) << 48;

		t |= ((uint64_t) (RC[r] >> 3) & 7) << 4;
		t |= ((uint64_t) (RC[r] >> 3) & 7) << (4+32);
		t |= ((uint64_t) (RC[r] >> 0) & 7) << (4+16);
		t |= ((uint64_t) (RC[r] >> 0) & 7) << (4+16+32);
		RRC[r] = t;
		printf("%" PRIu64 "," ,t);
	}

	// build the round keys
	// for(r = 0; r < RN; r++) { }
}

inline void SCShRMCS(uint64_t* s)
{
#if (NIB==2) && defined(_MEM_)
	*s = Ssbox[0][((uint8_t *)s)[0]] ^ Ssbox[1][((uint8_t *)s)[1]] ^ Ssbox[2][((uint8_t *)s)[2]] ^ Ssbox[3][((uint8_t *)s)[3]] ^ Ssbox[4][((uint8_t *)s)[4]] ^ Ssbox[5][((uint8_t *)s)[5]] ^ Ssbox[6][((uint8_t *)s)[6]] ^ Ssbox[7][((uint8_t *)s)[7]];
	//uint64_t x  = Ssbox[0][((uint8_t *)s)[0]]; x ^= Ssbox[1][((uint8_t *)s)[1]]; x ^= Ssbox[2][((uint8_t *)s)[2]]; x ^= Ssbox[3][((uint8_t *)s)[3]]; x ^= Ssbox[4][((uint8_t *)s)[4]]; x ^= Ssbox[5][((uint8_t *)s)[5]]; x ^= Ssbox[6][((uint8_t *)s)[6]]; x ^= Ssbox[7][((uint8_t *)s)[7]]; *s = x;
	//*s = Ssbox[0][((uint8_t *)s)[7]] ^ Ssbox[1][((uint8_t *)s)[6]] ^ Ssbox[2][((uint8_t *)s)[5]] ^ Ssbox[3][((uint8_t *)s)[4]] ^ Ssbox[4][((uint8_t *)s)[3]] ^ Ssbox[5][((uint8_t *)s)[2]] ^ Ssbox[6][((uint8_t *)s)[1]] ^ Ssbox[7][((uint8_t *)s)[0]];
#elif (NIB==4) && defined(_MEM_)
	*s = Ssbox[0][((uint16_t *)s)[0]] ^ Ssbox[1][((uint16_t *)s)[1]] ^ Ssbox[2][((uint16_t *)s)[2]] ^ Ssbox[3][((uint16_t *)s)[3]];
#else
	uint64_t x = 0, tmp = *s;
	int i;
	for(i = 0; i < TS; i++){
		x ^= Ssbox[i][tmp&INDEX_FILTER];
		tmp >>= (NIB<<2);
	}
	*s = x;
#endif
}

void printState(uint64_t s)
{
	int i;
	for(i = 0; i < 16; i++)
	{
		printf("%X ", (byte)s&0xF);
		s>>=4;
		if((i&3) == 3) printf("\n");
	}
	printf("\n");
}

#if LED<=64
uint64_t LEDRound(uint64_t state, uint64_t key)
#elif LED<=128
uint64_t LEDRound(uint64_t state, uint64_t key[2])
#endif
{
#ifdef _PRINT_
	printf("--------- input state --------------\n");
	printState(state);
	printf("-- input key with key size = %02d ---\n", LED);
#endif
	int i, j;
#if LED<=64
	uint64_t lkey = key & ((((uint64_t) 1) << LED)-1);
#ifdef _PRINT_
	printState(lkey);
#endif
	for(i = LED; i < 64; i+=i)
		lkey = (lkey<<i)^lkey;
#if NOKEY
#else
	state ^= lkey;
#endif
#elif LED<=128
	uint64_t lkeyl = key[0];
	uint64_t lkeyr, tkey;
	lkeyr = key[1] & ((((uint64_t) 1)<<(LED&0x3F))-1);
#ifdef _PRINT_
	printState(lkeyl);
	printState(lkeyr);
#endif
	lkeyr |= lkeyl<<(LED-64);
#if NOKEY
#else
	//state ^= key[0];
	state ^= lkeyl;
	tkey  = lkeyl;
	lkeyl = lkeyr|(tkey<<(LED-64));
	lkeyr = tkey>>(128-LED);
#endif
	uint8_t kindex = 1;
#endif
#ifdef _PRINT_
		printf("--------------------------------------\n");
#endif
	for(i = 0; i < RN; i+=4)
	{
		state ^= RRC[i+0]; 
#ifdef _PRINT_
		printf("----round %02d after adding constant----\n", i);
		printState(state);
#endif
		SCShRMCS(&state);
#ifdef _PRINT_
		printf("----round %02d output-------------------\n", i);
		printState(state);
#endif
		state ^= RRC[i+1]; 
#ifdef _PRINT_
		printf("----round %02d after adding constant----\n", i+1);
		printState(state);
#endif
		SCShRMCS(&state);
#ifdef _PRINT_
		printf("----round %02d output--------------------\n", i+1);
		printState(state);
#endif
		state ^= RRC[i+2]; 
#ifdef _PRINT_
		printf("----round %02d after adding constant----\n", i+2);
		printState(state);
#endif
		SCShRMCS(&state);
#ifdef _PRINT_
		printf("----round %02d output-------------------\n", i+2);
		printState(state);
#endif
		state ^= RRC[i+3]; 
#ifdef _PRINT_
		printf("----round %02d after adding constant----\n", i+3);
		printState(state);
#endif
		SCShRMCS(&state);
#ifdef _PRINT_
		printf("----round %02d output-------------------\n", i+3);
		printState(state);
#endif
#if LED<=64
#if NOKEY
#else
		lkey = ROLTKEY(lkey);
		state ^= lkey;
#endif
#elif LED<=128
#if NOKEY
#else
		//state ^= key[kindex]; kindex ^= 0x01;
		state ^= lkeyl;
		tkey  = lkeyl;
		lkeyl = lkeyr|(tkey<<(LED-64));
		lkeyr = tkey>>(128-LED);
#endif
#endif
	}
#ifdef _PRINT_
	printf("------------- final output -----------\n");
	printState(state);
	printf("------------- process ends -----------\n");
#endif
	return state;
}

#define SAMPLE	(1<<18)
void TestSpeed()
{
	uint64_t mess[SAMPLE];
	double bytes = SAMPLE*8;
	int i;
	for(i = 0; i < (SAMPLE); i++)
		mess[i] = SHA256RandomLong();
	uint64_t state = 0;
	tstart();
#if LED<=64
	for(i = 0; i < (SAMPLE); i++)
		state = LEDRound(state, mess[i]);
#elif LED<=128
	for(i = 0; i < (SAMPLE>>1); i++)
		state = LEDRound(state, mess+(i<<1));
	bytes /=2;
#endif
	double tt = (double) tdiff();
	double speed = tt / bytes;
	printf("%.5f cycles per byte.\n", speed);
}

void TestVectors()
{
#if LED<=64
	uint64_t state = 0, keys = 0;
	LEDRound(state, keys);
	printf("\n\n");
	state = 0xFEDCBA9876543210ULL;
	keys  = 0xFEDCBA9876543210ULL;
	LEDRound(state, keys);
#elif LED<=128
	uint64_t state = 0, keys[2] = { 0, 0};
	LEDRound(state, keys);
	printf("\n\n");
	state = 0xFEDCBA9876543210ULL;
	keys[0] = keys[1] = 0xFEDCBA9876543210ULL;
	LEDRound(state, keys);
#endif
}

void printSSBOX()
{
	int i, j;
	printf("const uint64_t Ssbox[8][1<<8] = {\n");
	for(i = 0; i < TS; i++)
	{
		printf("{ ");
		for(j = 0; j < (1<<(NIB<<2)); j++){
			printf("0x%016llXLL", (unsigned long long) Ssbox[i][j]);
			if(j+1 != (1<<(NIB<<2))) printf(", ");
		}
		printf("}");
		if(i+1 != TS) printf(",");
		printf("\n");
	}
	printf("};\n");
	printf("const uint64_t RRC[48] = {\n");
	for(i = 0; i < 48; i++){
		printf("0x%016llXLL", (unsigned long long) RRC[i]);
		if(i+1 !=48) printf(", ");
	}
	printf("};\n");
}

int main(int argc, char*argv[])
{
	srand(time(0));
	BuildTableSCShRMCS();
#ifdef _PRINT_
	TestVectors();
#else
	//printSSBOX();
	TestSpeed();
#endif
	return 0;
}
